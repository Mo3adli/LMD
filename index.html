<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة المعدل الجامعي - نظام LMD</title>
    
    <!-- Google Fonts: Tajawal -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- html2canvas library for saving as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kDXDCe9WSwsMaMachIYvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --background-color: #f4f7f9;
            --surface-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #e9ecef;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --debt-color: #17a2b8;
            --warning-color: #ffc107;
        }
        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --background-color: #111827;
            --surface-color: #1f2937;
            --text-color: #f9fafb;
            --text-muted-color: #9ca3af;
            --border-color: #374151;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        .app-container { position: relative; width: 100%; height: 100%; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%;
            height: 100%; padding: 1rem;
            display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; visibility: hidden; opacity: 0;
            transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
        }
        #main-page { justify-content: center; overflow-y: auto; }
        .page.active { visibility: visible; opacity: 1; transform: translateY(0); }
        .page-content { width: 100%; max-width: 700px; padding: 2rem 1rem;}
        #main-page .page-content { display: flex; flex-direction: column; justify-content: center; height: auto; min-height: 100%; }
        #page-semester-calculator .page-content { display: flex; flex-direction: column; height: 100%; padding-top: 1rem; padding-bottom: 0;}
        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 1rem; padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .page-header .page-title { font-size: 1.75rem; font-weight: 800; }
        .btn-back {
             background-color: transparent; color: var(--text-muted-color);
             border: none; width: 44px; height: 44px;
             border-radius: 50%; font-size: 1.5rem; cursor: pointer;
             box-shadow: none; transition: all 0.2s ease;
             display: flex; align-items: center; justify-content: center;
        }
        .btn-back:hover { color: var(--primary-color); background-color: var(--border-color); }
        .logo-container { text-align: center; margin-bottom: 2rem; }
        .app-logo { width: 180px; height: auto; }
        [data-theme="dark"] .logo-light-theme { display: none; }
        [data-theme="light"] .logo-dark-theme { display: none; }
        .choice-cards-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .choice-card {
            background-color: var(--surface-color); padding: 1.5rem; border-radius: 20px;
            text-align: center; border: 1px solid var(--border-color);
            box-shadow: var(--shadow); cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .choice-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); }
        .choice-card .icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; }
        .choice-card h3 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.25rem; }
        .choice-card p { color: var(--text-muted-color); font-size: 0.9rem;}
        .main-settings-link {
            width: 100%;
            margin-top: 1.5rem; padding: 1rem 2rem; border-radius: 20px;
            background-color: var(--surface-color); border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            gap: 0.75rem; cursor: pointer; transition: all 0.3s ease;
            font-weight: 700; font-size: 1.1rem; color: var(--text-muted-color);
            box-shadow: var(--shadow);
        }
        .main-settings-link:hover {
            color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 1.5rem; }
        html[dir="rtl"] .form-group { text-align: right; }
        html[dir="ltr"] .form-group { text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; }
        .form-control {
            width: 100%; padding: 0.75rem 1rem; border-radius: 10px;
            border: 1px solid var(--border-color); background-color: var(--background-color);
            color: var(--text-color); font-size: 1rem; font-family: 'Tajawal', sans-serif;
        }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent); }
        .form-control:disabled { background-color: var(--border-color); cursor: not-allowed; opacity: 0.7; }
        .btn { display: block; width: 100%; padding: 0.8rem 1.5rem; font-size: 1.1rem; font-weight: 700; font-family: 'Tajawal', sans-serif; text-align: center; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), color-mix(in srgb, var(--primary-color) 70%, #fff)); color: white; }
        .btn-add { background: linear-gradient(45deg, var(--success-color), color-mix(in srgb, var(--success-color) 70%, #fff)); color: white; }
        #modules-list { flex-grow: 1; overflow-y: auto; margin: 0 -1rem; padding: 0 1rem 1rem 1rem;}
        #modules-list p { height: 100%; display: flex; align-items: center; justify-content: center; margin: 0; padding: 0;}
        .page-actions-footer { flex-shrink: 0; padding-top: 1rem; background-color: var(--background-color);}
        .module-item { background: var(--surface-color); padding: 1rem; border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .module-info h4 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .module-details { display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9rem; color: var(--text-muted-color); }
        .kebab-menu { position: absolute; top: 1rem; background: transparent; border: none; font-size: 1.2rem; color: var(--text-muted-color); cursor: pointer; padding: 5px; }
        html[dir="rtl"] .kebab-menu { left: 1rem; }
        html[dir="ltr"] .kebab-menu { right: 1rem; }
        .module-options-menu { position: absolute; top: 2.5rem; background: var(--surface-color); border-radius: 8px; box-shadow: var(--shadow); z-index: 10; overflow: hidden; list-style: none; display: none; }
        html[dir="rtl"] .module-options-menu { left: 1rem; }
        html[dir="ltr"] .module-options-menu { right: 1rem; }
        .module-options-menu li { padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-weight: 500;}
        .module-options-menu li:hover { background-color: var(--background-color); }
        .module-options-menu .fa-solid { width: 15px; text-align: center; }
        .module-options-menu .edit-btn { color: var(--primary-color); }
        .module-options-menu .delete-btn { color: var(--danger-color); }
        .setting-item { background-color: var(--surface-color); padding: 1.25rem; border-radius: 15px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .setting-item-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .setting-item-header h4 { font-size: 1.1rem; margin: 0; }
        .setting-item-header .icon { font-size: 1.2rem; color: var(--text-muted-color); }
        .setting-item-header .chevron-icon { transition: transform 0.3s ease; }
        .setting-item.open .chevron-icon { transform: rotate(-180deg); }
        .setting-item .setting-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, margin-top 0.4s ease-out; }
        .setting-item.open .setting-content { max-height: 500px; margin-top: 1.5rem; }
        .toggle-switch { position: relative; width: 44px; height: 24px; background: #b3b3b3; border-radius: 32px; padding: 4px; transition: 300ms all; cursor: pointer; }
        .toggle-switch::before { transition: 300ms all; content: ""; position: absolute; width: 16px; height: 16px; border-radius: 35px; top: 50%; background: white; transform: translate(0, -50%); }
        html[dir="rtl"] .toggle-switch::before { left: 4px; }
        html[dir="ltr"] .toggle-switch::before { right: 4px; }
        .toggle-switch.active { background: var(--primary-color); }
        html[dir="rtl"] .toggle-switch.active::before { transform: translate(20px, -50%); }
        html[dir="ltr"] .toggle-switch.active::before { transform: translate(-20px, -50%); }
        .dropdown-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted-color); padding: 0 5px 5px 5px; }
        .setting-option { padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; }
        .setting-option:hover { background-color: var(--background-color); }
        .fa-check { color: var(--primary-color); opacity: 0; transition: opacity 0.2s; }
        .selected .fa-check { opacity: 1; }
        .feedback-textarea { width: 100%; min-height: 100px; padding: 1rem; border-radius: 10px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); margin: 1.5rem 0 1rem 0; resize: vertical; }
        .btn-send { background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 700; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; visibility: hidden; opacity: 0; transition: all 0.3s ease; pointer-events: none;}
        .modal-backdrop.active { visibility: visible; opacity: 1; pointer-events: auto;}
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 15px; width: 90%; max-width: 450px; transform: scale(0.9); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; position: relative; }
        html[dir="rtl"] .modal-content { text-align: right; }
        html[dir="ltr"] .modal-content { text-align: left; }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1.5rem; text-align: center; }
        .modal-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .modal-section:last-of-type { border-bottom: none; padding-bottom: 0; margin-bottom: 0;}
        .grade-input-group { display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 0 1rem; margin-bottom: 1rem; }
        .grade-input-group .grade-label { grid-column: 1 / 3; font-weight: 500; margin-bottom: 0.5rem; }
        .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .modal-error { color: var(--danger-color); margin-top: 1rem; text-align: center; font-weight: 500; display: none; }
        .social-links { text-align: center; }
        .social-links a { font-size: 2rem; margin: 0 1rem; color: var(--text-muted-color); transition: color 0.3s; }
        .social-links a:hover { color: var(--primary-color); }
        .btn-close-modal { position: absolute; top: 1rem; background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted-color); cursor: pointer; line-height: 1; }
        html[dir="rtl"] .btn-close-modal { right: 1rem; }
        html[dir="ltr"] .btn-close-modal { left: 1rem; }
        #result-modal .result-item { display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; padding: 1rem 0.5rem; border-bottom: 1px solid var(--border-color); }
        #result-modal .result-item:last-child { border-bottom: none; }
        #result-modal .result-label { font-weight: 500; }
        #result-modal .result-value { font-weight: 800; }
        #result-modal .final-status { font-size: 1.1rem; margin-top: 1.5rem; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 50px; display: inline-block; text-align: center; }
        #result-modal .final-status.success { background-color: color-mix(in srgb, var(--success-color) 20%, transparent); color: var(--success-color); }
        #result-modal .final-status.debt { background-color: color-mix(in srgb, var(--debt-color) 20%, transparent); color: var(--debt-color); }
        #result-modal .final-status.warning { background-color: color-mix(in srgb, var(--warning-color) 20%, transparent); color: var(--warning-color); }
        #result-modal .final-status.danger { background-color: color-mix(in srgb, var(--danger-color) 20%, transparent); color: var(--danger-color); }
        .action-btn { position: absolute; top: 1rem; background: transparent; border: none; font-size: 1.3rem; color: var(--text-muted-color); cursor: pointer; padding: 0.5rem; }
        html[dir="rtl"] .action-btn { left: 1rem; }
        html[dir="ltr"] .action-btn { right: 1rem; }
        .action-btn:hover { color: var(--primary-color); }
        #statement-modal { padding: 0; align-items: stretch; justify-content: stretch; }
        #statement-modal .modal-content { width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; display: flex; flex-direction: column; padding: 1rem; }
        #statement-content-body { flex-grow: 1; overflow-y: auto; padding-bottom: 1rem;}
        #statement-content h3 { font-size: 1.25rem; }
        .statement-header { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap: 0.5rem; padding: 0.5rem 0.75rem; background-color: var(--background-color); border-radius: 10px; font-weight: 700; margin-bottom: 0.5rem; font-size: 0.8rem; }
        .statement-header span { text-align: center; }
        html[dir="rtl"] .statement-header span:first-child { text-align: right; }
        html[dir="ltr"] .statement-header span:first-child { text-align: left; }
        .statement-row { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap: 0.5rem; padding: 0.45rem 0.75rem; border-bottom: 1px solid var(--border-color); align-items: center; font-size: 0.85rem; }
        .statement-row:last-child { border-bottom: none; }
        .statement-row span { text-align: center; font-weight: 500; }
        .statement-row span:first-child { letter-spacing: normal; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        html[dir="rtl"] .statement-row span:first-child { text-align: right; }
        html[dir="ltr"] .statement-row span:first-child { text-align: left; }
        .statement-summary { margin-top: auto; padding: 0.75rem 1rem; border-top: 2px solid var(--border-color); background-color: var(--surface-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem; }
        .summary-item { display: flex; align-items: baseline; gap: 0.5rem; font-size: 0.9rem; }
        .summary-item strong { font-weight: 700; color: var(--text-muted-color); }
        .summary-item .value { font-weight: 800; color: var(--text-color); }
        #watermark-light, #watermark-dark { position: absolute; bottom: 1rem; opacity: 0.05; width: 60px; height: auto; pointer-events: none; display: none;}
        html[dir="rtl"] #watermark-light, html[dir="rtl"] #watermark-dark { left: 1rem; }
        html[dir="ltr"] #watermark-light, html[dir="ltr"] #watermark-dark { right: 1rem; }
        @media (min-width: 640px) {
            .choice-cards-container { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="calculator-app" class="app-container">
        <!-- Main Page -->
        <main id="main-page" class="page active">
            <div class="page-content">
                <div class="logo-container">
                    <!-- Updated image path -->
                    <img src="assets/logo-light.png" alt="Logo" class="app-logo logo-light-theme">
                    <!-- Updated image path -->
                    <img src="assets/logo-dark.png" alt="Logo" class="app-logo logo-dark-theme">
                </div>

                <div class="choice-cards-container">
                    <div class="choice-card" data-target="page-semester-calculator">
                        <div class="icon"><i class="fa-solid fa-book-open-reader"></i></div>
                        <h3 data-translate-key="semester_gpa_card_title">المعدل الفصلي</h3>
                        <p data-translate-key="semester_gpa_card_desc">حساب معدل السداسي الواحد</p>
                    </div>
                    <div class="choice-card" data-target="page-annual-calculator">
                        <div class="icon"><i class="fa-solid fa-calendar-check"></i></div>
                        <h3 data-translate-key="annual_gpa_card_title">المعدل السنوي</h3>
                        <p data-translate-key="annual_gpa_card_desc">حساب المعدل العام للسنة</p>
                    </div>
                </div>
                 <div class="main-settings-link" id="main-page-settings-btn" role="button" tabindex="0">
                    <i class="fa-solid fa-gear"></i>
                    <span data-translate-key="settings">الإعدادات</span>
                </div>
            </div>
        </main>
        
        <!-- Semester Calculator Page -->
        <div id="page-semester-calculator" class="page">
             <div class="page-content">
                 <div class="page-header">
                    <h2 class="page-title" data-translate-key="semester_gpa_title">حساب المعدل الفصلي</h2>
                    <button class="btn-back" data-target="main-page"><i class="fa-solid fa-xmark"></i></button>
                </div>
                 <div id="modules-list"><p style="color:var(--text-muted-color); text-align:center; padding: 2rem 0;" data-translate-key="no_modules_yet">لم تتم إضافة أي مقياس بعد.</p></div>
                 <div class="page-actions-footer">
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="add-module-btn" class="btn btn-add" style="flex-grow: 1; margin: 0;" data-translate-key="add_new_module">+ إضافة مقياس جديد</button>
                        <button id="reset-modules-btn" class="btn" data-translate-title-key="delete_all_modules" style="background: var(--danger-color); color:white; flex-basis: 50px; flex-grow: 0; font-size: 1.2rem; padding: 0.8rem 1rem;"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                    <button id="show-semester-result-btn" class="btn btn-primary" style="margin-top: 0.5rem;" data-translate-key="show_result">إظهار النتيجة</button>
                 </div>
             </div>
        </div>
        <!-- Annual Calculator Page -->
        <div id="page-annual-calculator" class="page">
             <div class="page-content">
                <div class="page-header">
                    <h2 class="page-title" data-translate-key="annual_gpa_title">حساب المعدل السنوي</h2>
                    <button class="btn-back" data-target="main-page"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="form-group">
                    <label for="s1-avg" data-translate-key="s1_title">الفصل الأول</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" inputmode="decimal" data-is-grade-input="true" id="s1-avg" class="form-control" data-translate-placeholder-key="gpa_placeholder">
                        <input type="number" id="s1-credits" class="form-control" data-translate-placeholder-key="credits_placeholder" max="30" style="flex-basis: 100px; flex-grow: 0;">
                    </div>
                </div>
                <hr style="margin: 1.5rem 0; border: 1px solid var(--border-color);">
                <div class="form-group">
                    <label for="s2-avg" data-translate-key="s2_title">الفصل الثاني</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" inputmode="decimal" data-is-grade-input="true" id="s2-avg" class="form-control" data-translate-placeholder-key="gpa_placeholder">
                        <input type="number" id="s2-credits" class="form-control" data-translate-placeholder-key="credits_placeholder" max="30" style="flex-basis: 100px; flex-grow: 0;">
                    </div>
                </div>
                 <button id="show-annual-result-btn" class="btn btn-primary" data-translate-key="show_result">إظهار النتيجة</button>
             </div>
        </div>

        <!-- Settings Page -->
        <div id="settings-page" class="page">
            <div class="page-content">
                <div class="page-header"><h2 class="page-title" data-translate-key="settings">الإعدادات</h2><button class="btn-back" data-target="main-page"><i class="fa-solid fa-xmark"></i></button></div>
                
                <div class="setting-item" data-setting="calculation">
                    <div class="setting-item-header"><div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-calculator"></i><h4 data-translate-key="calculation_method">طريقة الحساب</h4></div><i class="fa-solid fa-chevron-down chevron-icon"></i></div>
                    <div class="setting-content">
                        <div class="dropdown-labels"><span>Exam</span><span>TD/TP</span></div>
                        <div class="setting-options-container">
                            <div data-value="0.6" class="setting-option calc-option"><span>60%</span> / <span>40%</span> <i class="fa-solid fa-check"></i></div>
                            <div data-value="0.5" class="setting-option calc-option"><span>50%</span> / <span>50%</span> <i class="fa-solid fa-check"></i></div>
                            <div data-value="0.67" class="setting-option calc-option"><span>67%</span> / <span>33%</span> <i class="fa-solid fa-check"></i></div>
                            <div data-value="0.4" class="setting-option calc-option"><span>40%</span> / <span>60%</span> <i class="fa-solid fa-check"></i></div>
                            <div data-value="0.7" class="setting-option calc-option"><span>70%</span> / <span>30%</span> <i class="fa-solid fa-check"></i></div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-item" data-setting="credits">
                    <div class="setting-item-header">
                        <div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-layer-group"></i><h4 data-translate-key="set_credits">تحديد الرصيد</h4></div>
                        <i class="fa-solid fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="setting-content">
                        <p style="font-size: 0.8rem; color: var(--text-muted-color); margin-bottom: 1rem; text-align: center;" data-translate-key="set_credits_desc">يرجى تحديد الرصيد السنوي المطلوب للإنتقال إلى السنة الموالية، حسب متطلبات كليتك.</p>
                        <div class="setting-options-container">
                            <div data-value="30" class="setting-option credit-option"><span>30</span> <i class="fa-solid fa-check"></i></div>
                            <div data-value="45" class="setting-option credit-option"><span>45</span> <i class="fa-solid fa-check"></i></div>
                        </div>
                    </div>
                </div>

                <div class="setting-item" data-setting="theme">
                     <div class="setting-item-header"><div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-palette"></i><h4 data-translate-key="theme">المظهر</h4></div><i class="fa-solid fa-chevron-down chevron-icon"></i></div>
                     <div class="setting-content">
                         <div class="setting-options-container">
                            <div class="setting-option theme-option" data-theme-value="light"><span data-translate-key="light_theme">الفاتح</span><i class="fa-solid fa-check"></i></div>
                            <div class="setting-option theme-option" data-theme-value="dark"><span data-translate-key="dark_theme">الداكن</span><i class="fa-solid fa-check"></i></div>
                         </div>
                     </div>
                </div>
                
                 <div class="setting-item" data-setting="language">
                     <div class="setting-item-header">
                         <div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-language"></i><h4 data-translate-key="language">اللغة</h4></div>
                         <i class="fa-solid fa-chevron-down chevron-icon"></i>
                     </div>
                     <div class="setting-content">
                         <div class="setting-options-container">
                            <div class="setting-option lang-option" data-lang-value="ar"><span data-translate-key="lang_ar">العربية</span><i class="fa-solid fa-check"></i></div>
                            <div class="setting-option lang-option" data-lang-value="en"><span data-translate-key="lang_en">English</span><i class="fa-solid fa-check"></i></div>
                            <div class="setting-option lang-option" data-lang-value="fr"><span data-translate-key="lang_fr">Français</span><i class="fa-solid fa-check"></i></div>
                         </div>
                     </div>
                </div>

                <div class="setting-item">
                    <div class="setting-item-header" style="cursor:default;"><div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-cloud-arrow-down"></i><h4 data-translate-key="save_changes">حفظ التغييرات</h4></div><div class="toggle-switch" id="save-settings-toggle"></div></div>
                </div>

                <div class="setting-item" id="contact-setting">
                    <div class="setting-item-header"><div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-envelope"></i><h4 data-translate-key="contact_us">تواصل معنا</h4></div></div>
                </div>

                <div class="setting-item" data-setting="about">
                    <div class="setting-item-header"><div style="display: flex; align-items: center; gap: 0.75rem;"><i class="icon fa-solid fa-circle-info"></i><h4 data-translate-key="about_app">عن التطبيق</h4></div><i class="fa-solid fa-chevron-down chevron-icon"></i></div>
                    <div class="setting-content">
                        <div class="about-text">
                            <p data-translate-key="about_p1">هذا التطبيق مخصص لمساعدة الطلاب الجزائريين على حساب معدلاتهم الفصليّة والسنويّة بدقة وسهولة، باستخدام طرق حساب متعددة تناسب مختلف الجامعات.</p>
                            <blockquote data-translate-key="about_p2">هل لديك أي أفكار أو اقتراحات حول التطبيق؟ سأكون ممتنًا لأي ردود فعل تساعدني في تطوير التطبيق وتلبية احتياجات المستخدمين بشكل أفضل.</blockquote>
                        </div>
                        <textarea id="feedback-text" class="feedback-textarea" data-translate-placeholder-key="feedback_placeholder"></textarea>
                        <button id="send-feedback-btn" class="btn btn-send" data-translate-key="send_feedback">إرسال الاقتراح</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

       <!-- Modals -->
    <div id="contact-modal" class="modal-backdrop"><div class="modal-content"><button class="btn-close-modal" data-modal="contact-modal"><i class="fa-solid fa-xmark"></i></button><h3 data-translate-key="contact_dev">تواصل مع المطور</h3><div class="social-links"><a href="https://www.instagram.com/med1.ben" target="_blank" title="Instagram"><i class="fa-brands fa-instagram"></i></a><a href="mailto:mohamedbendellalou@gmail.com" title="Email"><i class="fa-solid fa-envelope"></i></a></div><p style="margin-top: 1rem; color: var(--text-muted-color);">@med1.ben</p></div></div>
    <div id="module-modal" class="modal-backdrop"><div class="modal-content"><h3 id="modal-title">إضافة مقياس جديد</h3><div class="modal-section"><div class="form-group"><label for="modal-module-name" data-translate-key="module_name_label">اسم المقياس</label><input type="text" id="modal-module-name" class="form-control" data-translate-placeholder-key="module_name_placeholder"></div><div style="display: flex; gap: 0.5rem;"><div class="form-group" style="flex: 1;"><label for="modal-module-coeff" data-translate-key="coeff_label">المعامل</label><input type="number" id="modal-module-coeff" class="form-control" data-translate-placeholder-key="example_placeholder_2" max="10"></div><div class="form-group" style="flex: 1;"><label for="modal-module-credits" data-translate-key="credits_label">الرصيد</label><input type="number" id="modal-module-credits" class="form-control" data-translate-placeholder-key="example_placeholder_2" max="10"></div></div></div><div class="modal-section"><h4 style="margin-bottom:1rem; font-weight:700;" data-translate-key="calc_module_gpa">حساب معدل المقياس</h4><div class="grade-input-group"><span class="grade-label">TD</span><div class="toggle-switch" data-controls="td-input"></div><input type="text" inputmode="decimal" data-is-grade-input="true" id="td-input" class="form-control" placeholder="0-20" disabled="true"></div><div class="grade-input-group"><span class="grade-label">TP</span><div class="toggle-switch" data-controls="tp-input"></div><input type="text" inputmode="decimal" data-is-grade-input="true" id="tp-input" class="form-control" placeholder="0-20" disabled="true"></div><div class="grade-input-group"><span class="grade-label">Exam</span><div class="toggle-switch" data-controls="exam-input"></div><input type="text" inputmode="decimal" data-is-grade-input="true" id="exam-input" class="form-control" placeholder="0-20" disabled="true"></div></div><p id="modal-error" class="modal-error"></p><div class="modal-actions"><button id="save-module-btn" class="btn btn-primary" style="flex-grow: 1;" data-translate-key="save">حفظ</button><button id="cancel-module-btn" class="btn" style="flex-grow: 1; background-color: var(--border-color); color: var(--text-color);" data-translate-key="cancel">إلغاء</button></div></div></div>
    <div id="result-modal" class="modal-backdrop"><div class="modal-content" style="text-align:center;"><button class="btn-close-modal" data-modal="result-modal"><i class="fa-solid fa-xmark"></i></button><button class="action-btn" id="show-statement-btn" data-translate-title-key="view_statement_title"><i class="fa-solid fa-file-invoice"></i></button><h3 id="result-modal-title">النتيجة النهائية</h3><div id="result-modal-body"></div></div></div>
    <div id="statement-modal" class="modal-backdrop"><div class="modal-content" id="statement-content"><button class="btn-close-modal" data-modal="statement-modal"><i class="fa-solid fa-xmark"></i></button><button class="action-btn" id="save-statement-btn" data-translate-title-key="save_statement_title"><i class="fa-solid fa-floppy-disk"></i></button><h3 data-translate-key="statement_title">كشف النقاط</h3><div id="statement-content-body"><div class="statement-header"><span>المقياس</span><span>الرصيد</span><span>المعامل</span><span>المعدل</span></div><div id="statement-modules-list"></div></div><div id="statement-summary"></div><!-- Updated watermark paths --><img src="assets/logo-light.png" alt="Watermark" class="statement-watermark watermark-light-theme"><img src="assets/logo-dark.png" alt="Watermark" class="statement-watermark watermark-dark-theme"></div></div>
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <div style="text-align: center; font-size: 3rem; color: var(--danger-color); margin-bottom: 1rem;"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 id="confirm-modal-title" data-translate-key="alert_title">تنبيه</h3>
            <p id="confirm-modal-text" style="text-align: center; margin-bottom: 1.5rem; color: var(--text-muted-color); line-height: 1.6;"></p>
            <div class="modal-actions">
                <button id="confirm-modal-confirm-btn" class="btn" style="flex-grow: 1; background-color: var(--danger-color); color: white;" data-translate-key="confirm">تأكيد</button>
                <button id="confirm-modal-cancel-btn" class="btn" style="flex-grow: 1; background-color: var(--border-color); color: var(--text-color);" data-translate-key="cancel">إلغاء</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const get = (selector) => document.querySelector(selector);
            const getAll = (selector) => document.querySelectorAll(selector);

            const translations = {
                ar: {
                    main_title: 'حاسبة المعدل الجامعي',
                    semester_gpa_card_title: 'المعدل الفصلي',
                    semester_gpa_card_desc: 'حساب معدل السداسي الواحد',
                    annual_gpa_card_title: 'المعدل السنوي',
                    annual_gpa_card_desc: 'حساب المعدل العام للسنة',
                    settings: 'الإعدادات',
                    semester_gpa_title: 'حساب المعدل الفصلي',
                    annual_gpa_title: 'حساب المعدل السنوي',
                    no_modules_yet: 'لم تتم إضافة أي مقياس بعد.',
                    add_new_module: '+ إضافة مقياس جديد',
                    delete_all_modules: 'حذف كل المقاييس',
                    show_result: 'إظهار النتيجة',
                    s1_title: 'الفصل الأول',
                    s2_title: 'الفصل الثاني',
                    gpa_placeholder: 'المعدل',
                    credits_placeholder: 'الرصيد',
                    calculation_method: 'طريقة الحساب',
                    set_credits: 'تحديد الرصيد',
                    set_credits_desc: 'يرجى تحديد الرصيد السنوي المطلوب للإنتقال إلى السنة الموالية، حسب متطلبات كليتك.',
                    theme: 'المظهر',
                    light_theme: 'الفاتح',
                    dark_theme: 'الداكن',
                    language: 'اللغة',
                    lang_ar: 'العربية',
                    lang_en: 'English',
                    lang_fr: 'Français',
                    save_changes: 'حفظ التغييرات',
                    contact_us: 'تواصل معنا',
                    about_app: 'عن التطبيق',
                    about_p1: 'هذا التطبيق مخصص لمساعدة الطلاب الجزائريين على حساب معدلاتهم الفصليّة والسنويّة بدقة وسهولة، باستخدام طرق حساب متعددة تناسب مختلف الجامعات.',
                    about_p2: 'هل لديك أي أفكار أو اقتراحات حول التطبيق؟ سأكون ممتنًا لأي ردود فعل تساعدني في تطوير التطبيق وتلبية احتياجات المستخدمين بشكل أفضل.',
                    feedback_placeholder: 'اكتب اقتراحك هنا...',
                    send_feedback: 'إرسال الاقتراح',
                    contact_dev: 'تواصل مع المطور',
                    add_module_title: 'إضافة مقياس جديد',
                    edit_module_title: 'تعديل المقياس',
                    module_name_label: 'اسم المقياس',
                    module_name_placeholder: 'مثال: تحليل 1',
                    coeff_label: 'المعامل',
                    credits_label: 'الرصيد',
                    example_placeholder_2: 'مثال: 2',
                    calc_module_gpa: 'حساب معدل المقياس',
                    save: 'حفظ',
                    cancel: 'إلغاء',
                    final_result: 'النتيجة النهائية',
                    semester_result_title: 'نتيجة الفصل',
                    annual_result_title: 'النتيجة السنوية',
                    result_label: 'النتيجة',
                    credits_label_result: 'الرصيد',
                    remark_label: 'الملاحظة',
                    view_statement_title: 'عرض كشف النقاط',
                    save_statement_title: 'حفظ كشف النقاط كصورة',
                    statement_title: 'كشف النقاط',
                    module_th: 'المقياس',
                    credits_th: 'الرصيد',
                    coeff_th: 'المعامل',
                    grade_th: 'المعدل',
                    semester_gpa_summary: 'المعدل الفصلي',
                    earned_credits_summary: 'الرصيد المحصل',
                    remark_summary: 'الملاحظة',
                    alert_title: 'تنبيه',
                    confirm: 'تأكيد',
                    edit: 'تعديل',
                    delete: 'حذف',
                    confirm_delete_all_modules: 'هل أنت متأكد من أنك تريد حذف جميع المقاييس المسجلة؟',
                    confirm_change_calc_method: 'تغيير طريقة الحساب سيؤدي إلى حذف جميع المقاييس المضافة. هل تريد المتابعة؟',
                    confirm_change_credits_req: 'تغيير رصيد الانتقال سيؤدي إلى مسح بيانات المعدل السنوي المدخلة. هل تريد المتابعة؟',
                    error_no_modules: 'الرجاء إضافة مقياس واحد على الأقل.',
                    error_invalid_annual_values: 'الرجاء إدخال قيم صحيحة لجميع الحقول المطلوبة.',
                    error_max_modules: 'لا يمكن إضافة أكثر من 15 مقياسًا.',
                    error_fill_all_fields: 'يرجى تعبئة جميع الحقول المطلوبة.',
                    error_grade_invalid: 'يجب تفعيل وإدخال نقطة واحدة صالحة على الأقل (بين 0 و 20).',
                    error_feedback_empty: 'الرجاء كتابة اقتراحك أولاً.',
                    remark_excellent: 'ممتاز',
                    remark_very_good: 'جيد جدًا',
                    remark_good: 'جيد',
                    remark_fairly_good: 'قريب من الجيد',
                    remark_pass: 'مقبول',
                    remark_resit: 'استدراك',
                    remark_poor: 'ضعيف',
                    status_pass: 'ناجح ومنتقل',
                    status_debt: 'ناجح بالديون',
                    status_fail: 'إعادة السنة'
                },
                en: {
                    main_title: 'GPA Calculator',
                    semester_gpa_card_title: 'Semester GPA',
                    semester_gpa_card_desc: 'Calculate your semester GPA',
                    annual_gpa_card_title: 'Annual GPA',
                    annual_gpa_card_desc: 'Calculate your annual GPA',
                    settings: 'Settings',
                    semester_gpa_title: 'Semester GPA Calculation',
                    annual_gpa_title: 'Annual GPA Calculation',
                    no_modules_yet: 'No modules added yet.',
                    add_new_module: '+ Add New Module',
                    delete_all_modules: 'Delete All Modules',
                    show_result: 'Show Result',
                    s1_title: 'Semester 1',
                    s2_title: 'Semester 2',
                    gpa_placeholder: 'GPA',
                    credits_placeholder: 'Credits',
                    calculation_method: 'Calculation Method',
                    set_credits: 'Set Required Credits',
                    set_credits_desc: 'Please select the annual credits required to pass with debt, according to your faculty.',
                    theme: 'Theme',
                    light_theme: 'Light',
                    dark_theme: 'Dark',
                    language: 'Language',
                    lang_ar: 'العربية',
                    lang_en: 'English',
                    lang_fr: 'Français',
                    save_changes: 'Save Changes',
                    contact_us: 'Contact Us',
                    about_app: 'About App',
                    about_p1: 'This application is designed to help Algerian students calculate their semester and annual GPAs accurately and easily, using multiple calculation methods to suit different universities.',
                    about_p2: 'Do you have any ideas or suggestions about the app? I would be grateful for any feedback to help me improve the application and better meet user needs.',
                    feedback_placeholder: 'Write your suggestion here...',
                    send_feedback: 'Send Suggestion',
                    contact_dev: 'Contact Developer',
                    add_module_title: 'Add New Module',
                    edit_module_title: 'Edit Module',
                    module_name_label: 'Module Name',
                    module_name_placeholder: 'e.g., Analysis 1',
                    coeff_label: 'Coefficient',
                    credits_label: 'Credits',
                    example_placeholder_2: 'e.g., 2',
                    calc_module_gpa: 'Calculate Module Grade',
                    save: 'Save',
                    cancel: 'Cancel',
                    final_result: 'Final Result',
                    semester_result_title: 'Semester Result',
                    annual_result_title: 'Annual Result',
                    result_label: 'Result',
                    credits_label_result: 'Credits',
                    remark_label: 'Remark',
                    view_statement_title: 'View Statement of Marks',
                    save_statement_title: 'Save Statement as Image',
                    statement_title: 'Statement of Marks',
                    module_th: 'Module',
                    credits_th: 'Credits',
                    coeff_th: 'Coeff.',
                    grade_th: 'Grade',
                    semester_gpa_summary: 'Semester GPA',
                    earned_credits_summary: 'Earned Credits',
                    remark_summary: 'Remark',
                    alert_title: 'Warning',
                    confirm: 'Confirm',
                    edit: 'Edit',
                    delete: 'Delete',
                    confirm_delete_all_modules: 'Are you sure you want to delete all registered modules?',
                    confirm_change_calc_method: 'Changing the calculation method will delete all added modules. Do you want to continue?',
                    confirm_change_credits_req: 'Changing the required credits will clear the entered annual GPA data. Do you want to continue?',
                    error_no_modules: 'Please add at least one module.',
                    error_invalid_annual_values: 'Please enter valid values for all required fields.',
                    error_max_modules: 'Cannot add more than 15 modules.',
                    error_fill_all_fields: 'Please fill all required fields.',
                    error_grade_invalid: 'At least one valid grade (between 0 and 20) must be enabled and entered.',
                    error_feedback_empty: 'Please write your suggestion first.',
                    remark_excellent: 'Excellent',
                    remark_very_good: 'Very Good',
                    remark_good: 'Good',
                    remark_fairly_good: 'Fairly Good',
                    remark_pass: 'Pass',
                    remark_resit: 'Resit',
                    remark_poor: 'Poor',
                    status_pass: 'Promoted',
                    status_debt: 'Promoted with Debt',
                    status_fail: 'Repeat Year'
                },
                fr: {
                    main_title: 'Calculatrice de Moyenne',
                    semester_gpa_card_title: 'Moyenne Semestrielle',
                    semester_gpa_card_desc: 'Calculer la moyenne du semestre',
                    annual_gpa_card_title: 'Moyenne Annuelle',
                    annual_gpa_card_desc: 'Calculer la moyenne générale de l\'année',
                    settings: 'Paramètres',
                    semester_gpa_title: 'Calcul de la Moyenne Semestrielle',
                    annual_gpa_title: 'Calcul de la Moyenne Annuelle',
                    no_modules_yet: 'Aucun module ajouté pour le moment.',
                    add_new_module: '+ Ajouter un Nouveau Module',
                    delete_all_modules: 'Supprimer tous les modules',
                    show_result: 'Afficher le Résultat',
                    s1_title: 'Semestre 1',
                    s2_title: 'Semestre 2',
                    gpa_placeholder: 'Moyenne',
                    credits_placeholder: 'Crédits',
                    calculation_method: 'Méthode de Calcul',
                    set_credits: 'Définir les Crédits',
                    set_credits_desc: 'Veuillez sélectionner le nombre de crédits annuels requis pour passer avec dettes, selon votre faculté.',
                    theme: 'Thème',
                    light_theme: 'Clair',
                    dark_theme: 'Sombre',
                    language: 'Langue',
                    lang_ar: 'العربية',
                    lang_en: 'English',
                    lang_fr: 'Français',
                    save_changes: 'Enregistrer les modifications',
                    contact_us: 'Nous Contacter',
                    about_app: 'À Propos',
                    about_p1: 'Cette application est conçue pour aider les étudiants algériens à calculer leurs moyennes semestrielles et annuelles avec précision et facilité, en utilisant plusieurs méthodes de calcul adaptées aux différentes universités.',
                    about_p2: 'Avez-vous des idées ou des suggestions concernant l\'application ? Je serais reconnaissant de tout retour qui m\'aiderait à améliorer l\'application et à mieux répondre aux besoins des utilisateurs.',
                    feedback_placeholder: 'Écrivez votre suggestion ici...',
                    send_feedback: 'Envoyer la Suggestion',
                    contact_dev: 'Contacter le Développeur',
                    add_module_title: 'Ajouter un nouveau module',
                    edit_module_title: 'Modifier le module',
                    module_name_label: 'Nom du Module',
                    module_name_placeholder: 'Ex: Analyse 1',
                    coeff_label: 'Coefficient',
                    credits_label: 'Crédits',
                    example_placeholder_2: 'Ex: 2',
                    calc_module_gpa: 'Calculer la note du module',
                    save: 'Enregistrer',
                    cancel: 'Annuler',
                    final_result: 'Résultat Final',
                    semester_result_title: 'Résultat du Semestre',
                    annual_result_title: 'Résultat Annuel',
                    result_label: 'Résultat',
                    credits_label_result: 'Crédits',
                    remark_label: 'Mention',
                    view_statement_title: 'Voir le Relevé de Notes',
                    save_statement_title: 'Enregistrer comme Image',
                    statement_title: 'Relevé de Notes',
                    module_th: 'Module',
                    credits_th: 'Crédits',
                    coeff_th: 'Coeff.',
                    grade_th: 'Moyenne',
                    semester_gpa_summary: 'Moyenne Semestrielle',
                    earned_credits_summary: 'Crédits Obtenus',
                    remark_summary: 'Mention',
                    alert_title: 'Avertissement',
                    confirm: 'Confirmer',
                    edit: 'Modifier',
                    delete: 'Supprimer',
                    confirm_delete_all_modules: 'Êtes-vous sûr de vouloir supprimer tous les modules enregistrés ?',
                    confirm_change_calc_method: 'Changer la méthode de calcul supprimera tous les modules ajoutés. Voulez-vous continuer ?',
                    confirm_change_credits_req: 'Changer les crédits requis effacera les données de la moyenne annuelle. Voulez-vous continuer ?',
                    error_no_modules: 'Veuillez ajouter au moins un module.',
                    error_invalid_annual_values: 'Veuillez saisir des valeurs valides pour tous les champs requis.',
                    error_max_modules: 'Impossible d\'ajouter plus de 15 modules.',
                    error_fill_all_fields: 'Veuillez remplir tous les champs requis.',
                    error_grade_invalid: 'Au moins une note valide (entre 0 et 20) doit être activée et saisie.',
                    error_feedback_empty: 'Veuillez d\'abord écrire votre suggestion.',
                    remark_excellent: 'Excellent',
                    remark_very_good: 'Très Bien',
                    remark_good: 'Bien',
                    remark_fairly_good: 'Assez Bien',
                    remark_pass: 'Passable',
                    remark_resit: 'Rattrapage',
                    remark_poor: 'Faible',
                    status_pass: 'Admis',
                    status_debt: 'Admis avec Dettes',
                    status_fail: 'Ajourné'
                }
            };
            
            let state = {
                language: 'ar',
                theme: 'light',
                examWeight: 0.6,
                requiredCreditsForDebt: 30,
                saveSettings: true,
                modules: [],
                lastResult: {},
            };
            
            let confirmCallback = null;

            const saveState = () => {
                if (state.saveSettings) {
                    const modulesData = [];
                    getAll('.module-item').forEach(item => {
                        modulesData.push(JSON.parse(JSON.stringify(item.dataset)));
                    });
                    state.modules = modulesData;

                    localStorage.setItem('gpa_calc_state', JSON.stringify({
                        theme: state.theme,
                        language: state.language,
                        examWeight: state.examWeight,
                        requiredCreditsForDebt: state.requiredCreditsForDebt,
                        modules: state.modules
                    }));
                }
            };
            const loadState = () => {
                state.saveSettings = (localStorage.getItem('gpa_calc_save_pref') ?? 'true') === 'true';
                if (state.saveSettings) {
                    const savedState = JSON.parse(localStorage.getItem('gpa_calc_state'));
                    if (savedState) {
                        state.language = savedState.language || 'ar';
                        state.theme = savedState.theme || 'light';
                        state.examWeight = savedState.examWeight || 0.6;
                        state.requiredCreditsForDebt = savedState.requiredCreditsForDebt || 30;
                        state.modules = savedState.modules || [];
                    }
                }
            };

            const applyTheme = () => document.documentElement.setAttribute('data-theme', state.theme);
            const updateSaveToggleUI = () => get('#save-settings-toggle').classList.toggle('active', state.saveSettings);
            const updateThemeOptionsUI = () => getAll('.theme-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.themeValue === state.theme));
            const updateCalcMethodUI = () => getAll('.calc-option').forEach(opt => opt.classList.toggle('selected', Math.abs(parseFloat(opt.dataset.value) - state.examWeight) < 0.01));
            const updateRequiredCreditsUI = () => getAll('.credit-option').forEach(opt => opt.classList.toggle('selected', parseInt(opt.dataset.value) === state.requiredCreditsForDebt));
            const updateLanguageOptionsUI = () => getAll('.lang-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.langValue === state.language));
            
            const applyLanguage = () => {
                const lang = state.language;
                const dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.documentElement.lang = lang;
                document.documentElement.dir = dir;

                getAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                getAll('[data-translate-placeholder-key]').forEach(el => {
                    const key = el.dataset.translatePlaceholderKey;
                     if (translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });
                 getAll('[data-translate-title-key]').forEach(el => {
                    const key = el.dataset.translateTitleKey;
                     if (translations[lang][key]) {
                        el.title = translations[lang][key];
                    }
                });
            };

            const showPage = (pageId) => {
                getAll('.page').forEach(page => page.classList.remove('active'));
                get(`#${pageId}`)?.classList.add('active');
            };

            const openModal = (modalId) => {
                const modal = get(`#${modalId}`);
                if(modal) {
                    modal.classList.add('active');
                    if(modalId === 'statement-modal') {
                        get('#statement-content-body').scrollTop = 0;
                    }
                }
            };

            const closeModal = (modalId) => {
                 const modal = get(`#${modalId}`);
                if(modal) {
                    modal.classList.remove('active');
                }
            };
            
            const showConfirmationModal = (messageKey, onConfirm) => {
                get('#confirm-modal-title').textContent = translations[state.language]['alert_title'];
                get('#confirm-modal-text').textContent = translations[state.language][messageKey];
                confirmCallback = onConfirm;
                openModal('confirm-modal');
            };

            const clearAnnualInputs = () => {
                get('#s1-avg').value = '';
                get('#s1-credits').value = '';
                get('#s2-avg').value = '';
                get('#s2-credits').value = '';
                get('#s1-credits').disabled = false;
                get('#s2-credits').disabled = false;
            };

            const setupEventListeners = () => {
                get('#main-page-settings-btn').addEventListener('click', () => showPage('settings-page'));
                getAll('.btn-back').forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.target)));
                getAll('.choice-card').forEach(card => card.addEventListener('click', () => showPage(card.dataset.target)));
                get('#contact-setting').addEventListener('click', () => openModal('contact-modal'));
                getAll('.btn-close-modal').forEach(btn => {
                    btn.addEventListener('click', () => closeModal(btn.dataset.modal))
                });
                
                get('#confirm-modal-cancel-btn').addEventListener('click', () => {
                    closeModal('confirm-modal');
                    confirmCallback = null;
                });
                get('#confirm-modal-confirm-btn').addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') {
                        confirmCallback();
                    }
                    closeModal('confirm-modal');
                    confirmCallback = null;
                });
                
                getAll('.setting-item[data-setting]').forEach(item => {
                    item.querySelector('.setting-item-header').addEventListener('click', (e) => {
                        if (e.target.closest('.setting-content')) return;
                        item.classList.toggle('open');
                    });
                });

                getAll('.theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        state.theme = option.dataset.themeValue;
                        applyTheme();
                        updateThemeOptionsUI();
                        saveState();
                    });
                });
                
                getAll('.calc-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const newWeight = parseFloat(option.dataset.value);
                        if (Math.abs(newWeight - state.examWeight) > 0.01 && getAll('.module-item').length > 0) {
                            showConfirmationModal('confirm_change_calc_method', () => {
                                state.examWeight = newWeight;
                                updateCalcMethodUI();
                                clearModules(true);
                                saveState();
                            });
                        } else {
                            state.examWeight = newWeight;
                            updateCalcMethodUI();
                            saveState();
                        }
                    });
                });
                
                getAll('.credit-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const newCredits = parseInt(option.dataset.value);
                        if (newCredits === state.requiredCreditsForDebt) return;

                        const s1_avg = get('#s1-avg').value.trim();
                        const s2_avg = get('#s2-avg').value.trim();
                        const annualInputsFilled = s1_avg !== '' || s2_avg !== '';
                        
                        const changeCredits = () => {
                           state.requiredCreditsForDebt = newCredits;
                           updateRequiredCreditsUI();
                           saveState();
                        };

                        if (annualInputsFilled) {
                           showConfirmationModal('confirm_change_credits_req', () => {
                               clearAnnualInputs();
                               changeCredits();
                           });
                        } else {
                           changeCredits();
                        }
                    });
                });
                
                getAll('.lang-option').forEach(option => {
                    option.addEventListener('click', () => {
                        state.language = option.dataset.langValue;
                        applyLanguage();
                        updateLanguageOptionsUI();
                        saveState();
                    });
                });

                get('#save-settings-toggle').addEventListener('click', (e) => {
                    e.stopPropagation();
                    state.saveSettings = !state.saveSettings;
                    updateSaveToggleUI();
                    if (state.saveSettings) {
                        saveState(); 
                    } else {
                        localStorage.removeItem('gpa_calc_state');
                    }
                    localStorage.setItem('gpa_calc_save_pref', state.saveSettings);
                });

                get('#send-feedback-btn').addEventListener('click', () => {
                    const feedbackText = get('#feedback-text').value;
                    if (feedbackText.trim() === '') return showResultModal({ titleKey: 'alert_title', errorKey: 'error_feedback_empty' });
                    const subject = encodeURIComponent("Suggestion for GPA Calculator");
                    const body = encodeURIComponent(feedbackText);
                    window.location.href = `mailto:mohamedbendellalou@gmail.com?subject=${subject}&body=${body}`;
                });
                
                get('#show-statement-btn').addEventListener('click', () => generateAndShowStatement());
                
                get('#save-statement-btn').addEventListener('click', () => {
                    const statementElement = get('#statement-content');
                    if (!statementElement) return;

                    const title = 'Statement_of_Marks';
                    
                    const buttons = statementElement.querySelectorAll('.action-btn, .btn-close-modal');
                    buttons.forEach(btn => btn.style.visibility = 'hidden');

                    const watermarkLight = statementElement.querySelector('#watermark-light');
                    const watermarkDark = statementElement.querySelector('#watermark-dark');
                    if(watermarkLight) watermarkLight.style.display = state.theme === 'light' ? 'block' : 'none';
                    if(watermarkDark) watermarkDark.style.display = state.theme === 'dark' ? 'block' : 'none';

                    html2canvas(statementElement, {
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--surface-color').trim(),
                        useCORS: true,
                        scale: 2.5,
                        onclone: (clonedDoc) => {
                            const clonedWatermarkLight = clonedDoc.querySelector('#watermark-light');
                            const clonedWatermarkDark = clonedDoc.querySelector('#watermark-dark');
                            if(clonedWatermarkLight) clonedWatermarkLight.style.display = state.theme === 'light' ? 'block' : 'none';
                            if(clonedWatermarkDark) clonedWatermarkDark.style.display = state.theme === 'dark' ? 'block' : 'none';
                        }
                    }).then(canvas => {
                        buttons.forEach(btn => btn.style.visibility = 'visible');
                        if(watermarkLight) watermarkLight.style.display = 'none';
                        if(watermarkDark) watermarkDark.style.display = 'none';
                        
                        const link = document.createElement('a');
                        link.download = `${title}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }).catch(err => {
                        console.error("Oops, something went wrong!", err);
                        buttons.forEach(btn => btn.style.visibility = 'visible');
                        if(watermarkLight) watermarkLight.style.display = 'none';
                        if(watermarkDark) watermarkDark.style.display = 'none';
                    });
                });

                const enforceMaxInt = (el) => {
                    const max = parseInt(el.max);
                    let value = el.value.replace(/[^0-9]/g, '');
                    if (parseInt(value) > max) {
                        value = max;
                    }
                    el.value = value;
                };
                getAll('input[type="number"]').forEach(input => input.addEventListener('input', () => enforceMaxInt(input)));

                const formatGradeInput = (e) => {
                    let input = e.target;
                    let value = input.value;
                    
                    let sanitizedValue = value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');

                    if (parseFloat(sanitizedValue) > 20) {
                        sanitizedValue = '20.00';
                    }
                    
                    let parts = sanitizedValue.split('.');
                    if (parts[1] && parts[1].length > 2) {
                        sanitizedValue = parts[0] + '.' + parts[1].substring(0, 2);
                    }

                    if(input.value !== sanitizedValue) {
                        input.value = sanitizedValue;
                    }
                };
                getAll('input[data-is-grade-input="true"]').forEach(input => {
                    input.addEventListener('input', formatGradeInput);
                });


                const showResultModal = (data) => {
                    state.lastResult = data;
                    const T = translations[state.language];
                    get('#result-modal-title').textContent = T[data.titleKey] || data.titleKey;
                    const body = get('#result-modal-body');
                    body.innerHTML = '';
                    get('#show-statement-btn').style.display = 'none';

                    if (data.errorKey) {
                        body.innerHTML = `<p style="color:var(--danger-color); font-weight:500;">${T[data.errorKey]}</p>`;
                    } else if (data.isAnnual) {
                        const avgColor = data.average >= 10 ? 'var(--success-color)' : 'var(--danger-color)';
                        body.innerHTML = `<div class="result-item"><span class="result-label">${T.annual_gpa_title}:</span><span class="result-value" style="color: ${avgColor};">${data.average.toFixed(2)}</span></div><div class="result-item"><span class="result-label">${T.credits_label_result}:</span><span class="result-value">${data.credits} / 60</span></div>`;
                        if (data.status) body.innerHTML += `<div class="final-status ${data.status.class}">${T[data.status.textKey]}</div>`;
                    } else { 
                        const averageColor = data.average >= 10 ? 'var(--success-color)' : 'var(--danger-color)';
                        body.innerHTML = `<div class="result-item"><span class="result-label">${T.result_label}:</span><span class="result-value" style="color: ${averageColor};">${data.average.toFixed(2)}</span></div><div class="result-item"><span class="result-label">${T.credits_label_result}:</span><span class="result-value">${data.credits} / 30</span></div><div class="result-item"><span class="result-label">${T.remark_label}:</span><span class="result-value">${T[data.remarkKey]}</span></div>`;
                        get('#show-statement-btn').style.display = 'block';
                    }
                    openModal('result-modal');
                };
                
                const generateAndShowStatement = () => {
                    const T = translations[state.language];
                    const listContainer = get('#statement-modules-list');
                    const summaryContainer = get('#statement-summary');
                    listContainer.innerHTML = '';
                    summaryContainer.innerHTML = '';

                    const modules = getAll('.module-item');
                    modules.forEach(item => {
                        const { name, grade, coeff, credits } = item.dataset;
                        const row = document.createElement('div');
                        row.className = 'statement-row';
                        const gradeColor = parseFloat(grade) >= 10 ? 'var(--success-color)' : 'var(--danger-color)';
                        row.innerHTML = `<span>${name}</span><span>${credits}</span><span>${coeff}</span><span style="color: ${gradeColor}; font-weight: 700;">${parseFloat(grade).toFixed(2)}</span>`;
                        listContainer.appendChild(row);
                    });
                    
                    const { average, credits, remarkKey } = state.lastResult;
                    const avgColor = average >= 10 ? 'var(--success-color)' : 'var(--danger-color)';
                    summaryContainer.innerHTML = `<div class="summary-item"><strong>${T.semester_gpa_summary}:</strong><span class="value" style="color: ${avgColor}">${average.toFixed(2)}</span></div><div class="summary-item"><strong>${T.earned_credits_summary}:</strong><span class="value">${credits} / 30</span></div><div class="summary-item"><strong>${T.remark_summary}:</strong><span class="value">${T[remarkKey]}</span></div>`;

                    openModal('statement-modal');
                };

                const moduleModal = get('#module-modal');
                get('#add-module-btn').addEventListener('click', () => {
                    if(getAll('.module-item').length >= 15) {
                        showResultModal({titleKey: 'alert_title', errorKey: 'error_max_modules'});
                        return;
                    }
                    get('#modal-title').textContent = translations[state.language].add_module_title;
                    moduleModal.dataset.mode = 'add';
                    moduleModal.dataset.editId = '';
                    resetModalForm();
                    openModal('module-modal');
                });
                
                get('#reset-modules-btn').addEventListener('click', () => {
                    if (getAll('.module-item').length > 0) {
                        showConfirmationModal('confirm_delete_all_modules', clearModules);
                    }
                });

                get('#cancel-module-btn').addEventListener('click', () => closeModal('module-modal'));

                const resetModalForm = () => {
                    getAll('#module-modal input:not([type=checkbox])').forEach(i => i.value = '');
                    getAll('#module-modal .toggle-switch').forEach(t => t.classList.remove('active'));
                    getAll('.grade-input').forEach(i => { i.disabled = true; i.value = ''; });
                    get('#modal-error').style.display = 'none';
                };
                
                getAll('#module-modal .toggle-switch').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        toggle.classList.toggle('active');
                        const controlsInput = get(`#${toggle.dataset.controls}`);
                        controlsInput.disabled = !toggle.classList.contains('active');
                        
                        if(!controlsInput.disabled) controlsInput.focus();
                        else controlsInput.value = '';

                        if(toggle.dataset.controls === 'td-input' && toggle.classList.contains('active')) {
                            const tpToggle = get('[data-controls="tp-input"]');
                            tpToggle.classList.remove('active');
                            get('#tp-input').disabled = true;
                            get('#tp-input').value = '';
                        }
                        if(toggle.dataset.controls === 'tp-input' && toggle.classList.contains('active')) {
                            const tdToggle = get('[data-controls="td-input"]');
                            tdToggle.classList.remove('active');
                            get('#td-input').disabled = true;
                            get('#td-input').value = '';
                        }
                    });
                });
                
                get('#save-module-btn').addEventListener('click', () => {
                    const T = translations[state.language];
                    const name = get('#modal-module-name').value.trim();
                    const coeff = get('#modal-module-coeff').value.trim();
                    const credits = get('#modal-module-credits').value.trim();
                    const errorEl = get('#modal-error');
                    const showError = (msgKey) => { errorEl.textContent = T[msgKey]; errorEl.style.display = 'block'; };
                    
                    if (!name || !coeff || !credits) return showError('error_fill_all_fields');

                    const getVal = (input) => parseFloat(input.value);
                    const td = getVal(get('#td-input')), tp = getVal(get('#tp-input')), exam = getVal(get('#exam-input'));
                    const valid = (val) => !isNaN(val) && val >= 0 && val <= 20;
                    const tdActive = !get('#td-input').disabled && valid(td);
                    const tpActive = !get('#tp-input').disabled && valid(tp);
                    const examActive = !get('#exam-input').disabled && valid(exam);
                    if (!tdActive && !tpActive && !examActive) return showError('error_grade_invalid');

                    let finalGrade = 0;
                    const td_tp_weight = 1 - state.examWeight;
                    if (examActive && (tdActive || tpActive)) {
                        const continuousGrade = tdActive ? td : tp;
                        finalGrade = (exam * state.examWeight) + (continuousGrade * td_tp_weight);
                    } else if (examActive) finalGrade = exam;
                    else if (tdActive) finalGrade = td;
                    else if (tpActive) finalGrade = tp;

                    const moduleData = { name, coeff, credits, grade: finalGrade.toFixed(2), id: moduleModal.dataset.editId || Date.now().toString() };
                    if (moduleModal.dataset.mode === 'edit') {
                        const itemToEdit = get(`.module-item[data-id="${moduleData.id}"]`);
                        if (itemToEdit) updateModuleInList(itemToEdit, moduleData);
                    } else { addModuleToList(moduleData); }
                    saveState();
                    closeModal('module-modal');
                });
                
                const addModuleToList = (data) => {
                    const list = get('#modules-list');
                    if (list.querySelector('p')) list.innerHTML = '';
                    const item = document.createElement('div');
                    item.className = 'module-item';
                    list.appendChild(item);
                    updateModuleInList(item, data);
                };

                const updateModuleInList = (item, data) => {
                    const T = translations[state.language];
                    Object.keys(data).forEach(key => item.dataset[key] = data[key]);
                    item.innerHTML = `<button class="kebab-menu"><i class="fa-solid fa-ellipsis-v"></i></button><ul class="module-options-menu"><li class="edit-btn"><i class="fa-solid fa-pencil"></i> ${T.edit}</li><li class="delete-btn"><i class="fa-solid fa-trash"></i> ${T.delete}</li></ul><div class="module-info"><h4>${data.name}</h4><div class="module-details"><span><strong>${T.grade_th}:</strong> ${data.grade}</span><span><strong>${T.coeff_th}:</strong> ${data.coeff}</span><span><strong>${T.credits_th}:</strong> ${data.credits}</span></div></div>`;
                    item.querySelector('.kebab-menu').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const menu = item.querySelector('.module-options-menu');
                        getAll('.module-options-menu').forEach(m => { if(m !== menu) m.style.display = 'none'; });
                        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    });
                    item.querySelector('.delete-btn').addEventListener('click', () => {
                        item.remove();
                        if (get('#modules-list').childElementCount === 0) {
                            get('#modules-list').innerHTML = `<p style="color:var(--text-muted-color); text-align:center; padding: 2rem 0;" data-translate-key="no_modules_yet">${T.no_modules_yet}</p>`;
                        }
                        saveState();
                    });
                    item.querySelector('.edit-btn').addEventListener('click', () => {
                        get('#modal-title').textContent = T.edit_module_title;
                        moduleModal.dataset.mode = 'edit';
                        moduleModal.dataset.editId = item.dataset.id;
                        resetModalForm();
                        get('#modal-module-name').value = item.dataset.name;
                        get('#modal-module-coeff').value = item.dataset.coeff;
                        get('#modal-module-credits').value = item.dataset.credits;
                        openModal('module-modal');
                    });
                };
                
                const clearModules = (silent = false) => {
                     get('#modules-list').innerHTML = `<p style="color:var(--text-muted-color); text-align:center; padding: 2rem 0;" data-translate-key="no_modules_yet">${translations[state.language].no_modules_yet}</p>`;
                     if (!silent) saveState();
                }

                document.body.addEventListener('click', () => getAll('.module-options-menu').forEach(m => m.style.display = 'none'));

                const getRemarkKey = (grade) => {
                    if (grade >= 18) return 'remark_excellent'; if (grade >= 16) return 'remark_very_good';
                    if (grade >= 14) return 'remark_good'; if (grade >= 12) return 'remark_fairly_good';
                    if (grade >= 10) return 'remark_pass'; if (grade >= 7) return 'remark_resit'; return 'remark_poor';
                };

                get('#show-semester-result-btn').addEventListener('click', () => {
                    if(navigator.vibrate) navigator.vibrate(50);
                    let totalPoints = 0, totalCoeffs = 0, earnedCredits = 0;
                    const modules = getAll('.module-item');
                    if (modules.length === 0) return showResultModal({ titleKey: 'alert_title', errorKey: 'error_no_modules' });
                    
                    modules.forEach(item => {
                        const grade = parseFloat(item.dataset.grade);
                        const coeff = parseFloat(item.dataset.coeff);
                        const credits = parseFloat(item.dataset.credits);
                        
                        totalPoints += grade * coeff;
                        totalCoeffs += coeff;

                        if (grade >= 10) {
                            earnedCredits += credits;
                        }
                    });

                    const average = totalCoeffs > 0 ? totalPoints / totalCoeffs : 0;
                    const finalCredits = average >= 10 ? 30 : earnedCredits;

                    showResultModal({ 
                        titleKey: 'semester_result_title', 
                        average: average, 
                        credits: finalCredits, 
                        remarkKey: getRemarkKey(average) 
                    });
                });

                const handleAnnualCredits = (avgInput, creditsInput) => {
                    const avg = parseFloat(avgInput.value);
                    const isDisabled = !isNaN(avg) && avg >= 10;
                    creditsInput.disabled = isDisabled;

                    if (isDisabled) {
                        creditsInput.value = 30;
                    } else {
                        if (creditsInput.value === '30' && !avgInput.value.endsWith('.')) {
                           creditsInput.value = '';
                        }
                    }
                };
                get('#s1-avg').addEventListener('input', () => handleAnnualCredits(get('#s1-avg'), get('#s1-credits')));
                get('#s2-avg').addEventListener('input', () => handleAnnualCredits(get('#s2-avg'), get('#s2-credits')));

                get('#show-annual-result-btn').addEventListener('click', () => {
                    if(navigator.vibrate) navigator.vibrate(50);
                    const s1_avg = parseFloat(get('#s1-avg').value);
                    let s1_credits = parseFloat(get('#s1-credits').value);
                    const s2_avg = parseFloat(get('#s2-avg').value);
                    let s2_credits = parseFloat(get('#s2-credits').value);

                    if (s1_avg >= 10) s1_credits = 30;
                    if (s2_avg >= 10) s2_credits = 30;

                    const valid = (...vals) => vals.every(v => !isNaN(v) && v >= 0);
                    if (!valid(s1_avg, s1_credits, s2_avg, s2_credits)) {
                        return showResultModal({ titleKey: 'alert_title', errorKey: 'error_invalid_annual_values' });
                    }
                    
                    const annual_avg = (s1_avg + s2_avg) / 2;
                    let total_credits = s1_credits + s2_credits;
                
                    let status;
                    if (annual_avg >= 10 || total_credits >= 60) {
                        status = { textKey: 'status_pass', class: 'success' };
                        total_credits = 60;
                    } else if (total_credits >= state.requiredCreditsForDebt) {
                        status = { textKey: 'status_debt', class: 'debt' };
                    } else {
                        status = { textKey: 'status_fail', class: 'danger' };
                    }
                    
                    showResultModal({ isAnnual: true, titleKey: 'annual_result_title', average: annual_avg, credits: total_credits, status: status });
                });
            };
            
            // --- Initialization ---
            const init = () => {
                loadState();
                applyTheme();
                applyLanguage();
                updateSaveToggleUI();
                updateThemeOptionsUI();
                updateCalcMethodUI();
                updateRequiredCreditsUI();
                updateLanguageOptionsUI();
                if (state.modules && state.modules.length > 0) {
                    const list = get('#modules-list');
                    list.innerHTML = '';
                    state.modules.forEach(moduleData => addModuleToList(moduleData));
                }
                setupEventListeners();
                showPage('main-page');
            };

            init();
        });
    </script>
</body>
</html>
